# 微前端解决的问题

1. 用不同技术栈开发同一个应用；

2. 独立开发，独立部署；
3. 对旧的项目可以增量迁移，减少推倒重构；

# 实现

1. 将应用划分成若干个子应用，将子应用打包成一个个的模块。路径切换时加载不同子应用，而子应用技术栈独立。
2. 子应用需要暴露固定的钩子， bootstrap， mount，unmount。

# 微前端历史

- 2018年 Single-SPA诞生了， `single-spa`是一个用于前端微服务化的`JavaScript`前端解决方案 (本身**没有处理样式隔离，`js`执行隔离**) 实现了路由劫持和应用加载，需要systemJs 配合。

- 2019年 `qiankun`基于Single-SPA, 提供了更加开箱即用的 `API` （`single-spa` + `sandbox` + `import-html-entry`） 做到了，技术栈无关、并且接入简单（像i`frame`一样简单），模块加载处理不是很好，通信不是很方便，可以将多个应用接入到父应用中；
- 2020年 EMP 基于 module Federation ，接入成本低，解决第三方包问题；

> 总结：子应用可以独立构建，运行时动态加载,主子应用完全解耦，技术栈无关，靠的是协议接入（qiankun 子应用必须导出 bootstrap、mount、unmount方法）

**这不是`iframe`吗？**

- 如果使用`iframe`，`iframe`中的子应用切换路由时用户刷新页面就尴尬了。

**应用通信**:

- 基于URL来进行数据传递，但是传递消息能力弱
- 基于`CustomEvent`实现通信
- 基于props主子应用间通信
- 使用全局变量、`Redux`进行通信

**公共依赖**:

- `CDN` - externals
- `webpack`联邦模块





# SystemJS

一个通用的模块加载器，能在浏览器上动态加载模块。微前端的核心就是加载微应用，再将应用打包成模块，再在浏览器中通过 systemjs 来加载模块；single-spa 需要依赖此加载器。



## single-spa 实战

#### 1、搭建 react 项目

```shell
yarn init -y

yarn add webpack webpack-cli webpack-dev-server babel-loader @babel/core @babel/preset-env @babel/preset-react html-webpack-plugin -D

yarn add react react-dom -S
```



### webpack 以 syetemjs 方式打包

- syetemjs ： 浏览器通用模块加载器；

- 打包命令：

```json
 "build": "webpack --env production"
```

- 打包关键配置：

```js
// 生产时遵循 system 模块规范来打包， ”“ 会打包成自执行函数
output.libraryTarget =  env.production ? "system" : "",
// 生产时忽略打包，对 react 和 react-dom 使用 cdn 方式加载，不参与打包    
externals: env.production ? ["react", "react-dom"] : [], 
```

- 打包结果使用

  > 当react和react-dom加载完毕后，才会加载 index.js。
  >
  > 

  ```html
  <!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <title>Title</title>
    </head>
    <body>
      <script type="systemjs-importmap">
        {
          "imports": {
            "react": "https://cdn.bootcdn.net/ajax/libs/react/17.0.2/umd/react.development.min.js",
            "react-dom": "https://cdn.bootcdn.net/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"
          }
        }
      </script>
      <div id="root"></div>
      <script src="https://cdn.bootcdn.net/ajax/libs/systemjs/6.12.1/system.js"></script>
      <script>
        // 引入 index.js 前，需要先加载 react 和 react-dom 两个模块
        System.import("./index.js");
      </script>
    </body>
  </html>
  
  ```

### systemjs 原理



















